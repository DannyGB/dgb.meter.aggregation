#
# Combines all services into one docker image
#

FROM golang:1.19.1 AS final

# aggregation

RUN mkdir -p /app/agg/cmd
WORKDIR /app/agg/cmd

COPY --from=dannygb/meter-aggregation:1.0 /app/agg/cmd/meter.aggregation .

ARG ENVIRONMENT=dev
ENV AGGREGATION_READINGS_ENV $ENVIRONMENT

ARG HTTP_PORT=80
ENV AGGREGATION_HTTP_PORT $HTTP_PORT

ARG ELEC_BACKEND=
ENV AGGREGATION_ELEC_BACKEND $ELEC_BACKEND

ARG OIL_BACKEND=
ENV AGGREGATION_OIL_BACKEND $OIL_BACKEND

ARG CORS_CLIENTS="*"
ENV AGGREGATION_CORS_CLIENTS $CORS_CLIENTS

# elec

RUN mkdir -p /app/elec/cmd/meter.readings
WORKDIR /app/elec/cmd/meter.readings

COPY --from=dannygb/meter:a7fe76ed43a94b42d66292a0407cc23466fbd794 /app/cmd/meter.readings/meter.readings .

ARG ENVIRONMENT
ENV METER_READINGS_ENVIRONMENT $ENVIRONMENT

ARG HTTP_PORT
ENV METER_READINGS_HTTP_PORT $HTTP_PORT

ARG MONGO_COLLECTION
ENV METER_READINGS_MONGO_COLLECTION $MONGO_COLLECTION

ARG MONGO_DB
ENV METER_READINGS_MONGO_DB $MONGO_DB

ARG MONGO_CONNECTION
ENV METER_READINGS_MONGO_CONNECTION $MONGO_CONNECTION

ARG CORS_CLIENTS
ENV METER_READINGS_CORS_CLIENTS $CORS_CLIENTS

# oil

RUN mkdir -p /app/oil/cmd/meter.readings.oil
WORKDIR /app/oil/cmd/meter.readings.oil

COPY --from=dannygb/meteroil:66cfcf58a03cb554efd9f0698f76c695edfd25f8 /app/cmd/meter.readings.oil/meter.readings.oil .

ARG HTTP_PORT_OIL
ENV METER_OIL_READINGS_HTTP_PORT $HTTP_PORT_OIL

ARG MONGO_COLLECTION_OIL
ENV METER_OIL_READINGS_MONGO_COLLECTION $MONGO_COLLECTION_OIL


# notifications

RUN mkdir -p /app/notifications/cmd/meter.notifications
WORKDIR /app/notifications/cmd/meter.notifications

COPY --from=dannygb/meternotifications:4a050ed844ea3190a6895a365d0449e3c7dbe166 /app/cmd/meter.notifications/meter.notifications .

ARG SMTP_USERNAME
ENV METER_READINGS_NOTIFICATIONS_SMTP_USERNAME $SMTP_USERNAME

ARG SMTP_PASSWORD
ENV METER_READINGS_NOTIFICATIONS_SMTP_PASSWORD $SMTP_PASSWORD

ARG SMTP_HOST
ENV METER_READINGS_NOTIFICATIONS_SMTP_HOST $SMTP_HOST

ARG SMTP_PORT
ENV METER_READINGS_NOTIFICATIONS_SMTP_PORT $SMTP_PORT

ARG SMTP_FROM
ENV METER_READINGS_NOTIFICATIONS_SMTP_FROM $SMTP_FROM

ARG RECIPIENTS
ENV METER_READINGS_NOTIFICATIONS_RECIPIENTS $RECIPIENTS

ARG WEBSITE
ENV METER_READINGS_NOTIFICATIONS_WEBSITE $WEBSITE

ARG SUBJECT="Meter Reading Due"
ENV METER_READINGS_NOTIFICATIONS_SUBJECT $SUBJECT

ARG HTTP_NOTIFICATION_PORT
ENV METER_READINGS_NOTIFICATIONS_HTTP_PORT $HTTP_NOTIFICATION_PORT

ARG TELEGRAM_BOT_TOKEN
ENV METER_READINGS_NOTIFICATIONS_TELEGRAM_BOT_TOKEN $TELEGRAM_BOT_TOKEN

ARG DISABLE_EMAIL
ENV METER_READINGS_NOTIFICATIONS_DISABLE_EMAIL $DISABLE_EMAIL

ARG TELEGRAM_CHANNEL_ID
ENV METER_READINGS_NOTIFICATIONS_TELEGRAM_CHANNEL_ID $TELEGRAM_CHANNEL_ID

# telegram bot

RUN mkdir -p /app/bot/cmd/meter.readings.bot
WORKDIR /app/bot/cmd/meter.readings.bot

COPY --from=dannygb/meterbot:678f30f0bb38cd88b656a5890a80874413d73666 /app/cmd/meter.readings.bot/meter.readings.bot .

ARG HTTP_BOT_PORT
ENV METER_READINGS_TELEGRAM_BOT_HTTP_PORT $HTTP_BOT_PORT

ARG TELEGRAM_BOT_TOKEN
ENV METER_READINGS_TELEGRAM_BOT_TOKEN $TELEGRAM_BOT_TOKEN

ARG TELEGRAM_VALID_USERS
ENV METER_READINGS_TELEGRAM_VALID_USERS $TELEGRAM_VALID_USERS

##

WORKDIR /app/
COPY ./start-all.sh .

RUN chmod +x start-all.sh

CMD [ "/app/start-all.sh" ]
